name: ğŸ“¸ Captura Semanal Automatizada

on:
  schedule:
    # Ejecutar cada lunes a las 9:00 AM UTC (6:00 AM Argentina)
    - cron: '0 9 * * 1'
  
  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
    inputs:
      max_workers:
        description: 'NÃºmero de capturas simultÃ¡neas (1-3)'
        required: false
        default: '2'
        type: choice
        options:
        - '1'
        - '2'
        - '3'

jobs:
  capture-websites:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ›’ Descargar cÃ³digo del repositorio
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸŸ¢ Configurar Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Instalar SingleFile CLI automÃ¡ticamente
      run: |
        echo "ğŸ”§ Instalando SingleFile CLI..."
        npm install -g single-file-cli
        echo "âœ… SingleFile CLI instalado:"
        single-file --version
        
    - name: ğŸŒ Instalar Chrome para capturas
      run: |
        echo "ğŸ”§ Instalando Google Chrome..."
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "âœ… Chrome instalado:"
        google-chrome --version
        
    - name: ğŸ“‹ Validar configuraciÃ³n
      run: |
        echo "ğŸ” Verificando archivos necesarios..."
        
        if [ ! -f "config/urls.json" ]; then
          echo "âŒ ERROR: config/urls.json no encontrado"
          echo "ğŸ’¡ Crea este archivo con tus URLs"
          exit 1
        fi
        
        if [ ! -f "scripts/capture.py" ]; then
          echo "âŒ ERROR: scripts/capture.py no encontrado"
          exit 1
        fi
        
        # Contar URLs configuradas - INDENTACIÃ“N CORREGIDA
        urls_count=$(python3 -c "
import json
try:
    with open('config/urls.json', 'r') as f:
        config = json.load(f)
    print(len(config.get('urls', {})))
except:
    print(0)
")
        
        echo "âœ… ConfiguraciÃ³n vÃ¡lida"
        echo "ğŸ“Š URLs configuradas: $urls_count"
        
        if [ "$urls_count" -eq "0" ]; then
          echo "âš ï¸ ADVERTENCIA: No hay URLs configuradas"
        fi
        
    - name: ğŸ“¸ Ejecutar capturas semanales
      env:
        MAX_WORKERS: ${{ github.event.inputs.max_workers || '2' }}
      run: |
        echo "ğŸš€ Iniciando captura semanal..."
        echo "âš™ï¸ Workers simultÃ¡neos: $MAX_WORKERS"
        echo "ğŸ“… Fecha: $(date)"
        echo ""
        
        python3 scripts/capture.py --max-workers $MAX_WORKERS
        
    - name: ğŸ“Š Generar reportes finales
      if: always()
      run: |
        echo "ğŸ“‹ Generando reportes..."
        
        if [ -f "scripts/update_readme.py" ]; then
          python3 scripts/update_readme.py
        fi
        
        # Mostrar resumen en logs - INDENTACIÃ“N CORREGIDA
        if [ -f "capturas/latest/report.json" ]; then
          echo ""
          echo "ğŸ“Š RESUMEN DE CAPTURA:"
          echo "====================="
          python3 -c "
import json
try:
    with open('capturas/latest/report.json', 'r') as f:
        data = json.load(f)
    stats = data.get('estadisticas', {})
    print(f'âœ… Exitosas: {stats.get("exitosas", 0)}')
    print(f'âŒ Fallidas: {stats.get("fallidas", 0)}')
    print(f'â±ï¸ Tiempo total: {stats.get("tiempo_total_segundos", 0):.1f}s')
    print(f'ğŸ’¾ TamaÃ±o total: {stats.get("tamaÃ±o_total_mb", 0):.1f} MB')
except Exception as e:
    print(f'Error leyendo reporte: {e}')
"
        fi
        
    - name: ğŸ“¦ Crear archivo comprimido de capturas
      if: success()
      run: |
        echo "ğŸ“¦ Creando archivo comprimido..."
        
        # Crear ZIP con todas las capturas de esta semana
        if [ -d "capturas" ]; then
          # Crear nombre con fecha
          fecha=$(date +%Y-%m-%d)
          zip_name="capturas-semana-$fecha"
          
          # Comprimir solo archivos HTML y reportes
          cd capturas
          zip -r "../$zip_name.zip" . -i "*.html" "*.json" "*.md"
          cd ..
          
          echo "âœ… Archivo creado: $zip_name.zip"
          
          # Mostrar tamaÃ±o del archivo
          if [ -f "$zip_name.zip" ]; then
            size_mb=$(du -m "$zip_name.zip" | cut -f1)
            echo "ğŸ“¦ TamaÃ±o del ZIP: ${size_mb}MB"
          fi
        fi
        
    - name: ğŸ“¤ Subir capturas como artefactos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: capturas-${{ github.run_number }}
        path: |
          capturas-*.zip
          capturas/latest/
        retention-days: 30
        compression-level: 0
        
    - name: ğŸ’¾ Guardar reportes en el repositorio
      if: success()
      run: |
        echo "ğŸ’¾ Guardando reportes en Git..."
        
        # Configurar Git
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions Bot"
        
        # Agregar solo reportes (no archivos HTML grandes)
        git add README.md || echo "README.md no changed"
        git add capturas/latest/report.json || echo "No report.json"
        git add capturas/latest/summary.md || echo "No summary.md"
        
        # Commit solo si hay cambios - INDENTACIÃ“N CORREGIDA
        if ! git diff --staged --quiet; then
          fecha=$(date +%Y-%m-%d)
          urls_count=$(python3 -c "
import json
try:
    with open('config/urls.json', 'r') as f:
        config = json.load(f)
    print(len(config.get('urls', {})))
except:
    print('?')
")
          
          git commit -m "ğŸ“¸ Captura automÃ¡tica $fecha - $urls_count URLs procesadas"
          git push
          echo "âœ… Reportes guardados en Git"
        else
          echo "ğŸ“Š Sin cambios en reportes"
        fi
        
    - name: ğŸš¨ NotificaciÃ³n de errores
      if: failure()
      run: |
        echo ""
        echo "ğŸš¨ ========================================"
        echo "    ERROR EN CAPTURA SEMANAL"
        echo "========================================"
        echo ""
        echo "âŒ La captura semanal ha fallado"
        echo "ğŸ” Revisa los logs arriba para mÃ¡s detalles"
        echo "ğŸ’¡ Posibles causas:"
        echo "   â€¢ URLs inaccesibles"
        echo "   â€¢ ConfiguraciÃ³n incorrecta"
        echo "   â€¢ Timeout en alguna pÃ¡gina"
        echo ""
        echo "ğŸ”§ Para solucionarlo:"
        echo "   1. Revisa config/urls.json"
        echo "   2. Verifica que las URLs sean pÃºblicas"
        echo "   3. Ejecuta manualmente para mÃ¡s detalles"
        echo ""
        
    - name: âœ… Resumen final
      if: always()
      run: |
        echo ""
        echo "âœ… ========================================"
        echo "    CAPTURA SEMANAL COMPLETADA"
        echo "========================================"
        echo ""
        echo "ğŸ“… Fecha: $(date)"
        echo "âš™ï¸ Workflow: ${{ github.workflow }}"
        echo "ğŸ”¢ EjecuciÃ³n: #${{ github.run_number }}"
        echo ""
        echo "ğŸ“Š Para ver resultados:"
        echo "   â€¢ Ve a la pestaÃ±a 'Actions'"
        echo "   â€¢ Descarga los 'Artifacts'"
        echo "   â€¢ Revisa las capturas en ZIP"
        echo ""
        echo "ğŸ”„ PrÃ³xima ejecuciÃ³n: PrÃ³ximo lunes 9:00 AM UTC"
        echo ""
