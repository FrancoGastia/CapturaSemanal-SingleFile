name: ğŸ“¸ Captura Semanal - SOLO MANUAL

# SOLO EJECUCIÃ“N MANUAL - SIN AUTOMATIZACIÃ“N
on:
  # Permitir SOLO ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
    inputs:
      max_workers:
        description: 'NÃºmero de capturas simultÃ¡neas (1-3)'
        required: false
        default: '1'
        type: choice
        options:
        - '1'
        - '2'
        - '3'

jobs:
  capture-websites:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ›’ Descargar cÃ³digo del repositorio
      uses: actions/checkout@v4
      
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸŸ¢ Configurar Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Instalar SingleFile CLI automÃ¡ticamente
      run: |
        echo "ğŸ”§ Instalando SingleFile CLI..."
        npm install -g single-file-cli
        echo "âœ… SingleFile CLI instalado:"
        single-file --version
        
    - name: ğŸŒ Instalar Chrome para capturas
      run: |
        echo "ğŸ”§ Instalando Google Chrome..."
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "âœ… Chrome instalado:"
        google-chrome --version
        
    - name: ğŸ“‹ Validar configuraciÃ³n
      run: |
        echo "ğŸ” Verificando archivos necesarios..."
        
        if [ ! -f "config/urls.json" ]; then
          echo "âŒ ERROR: config/urls.json no encontrado"
          echo "ğŸ’¡ Crea este archivo con tus URLs"
          exit 1
        fi
        
        if [ ! -f "scripts/capture.py" ]; then
          echo "âŒ ERROR: scripts/capture.py no encontrado"
          exit 1
        fi
        
        # Contar URLs configuradas
        urls_count=$(python3 -c "
import json
try:
    with open('config/urls.json', 'r') as f:
        config = json.load(f)
    print(len(config.get('urls', {})))
except:
    print(0)
")
        
        echo "âœ… ConfiguraciÃ³n vÃ¡lida"
        echo "ğŸ“Š URLs configuradas: $urls_count"
        
        if [ "$urls_count" -eq "0" ]; then
          echo "âš ï¸ ADVERTENCIA: No hay URLs configuradas"
        fi
        
    - name: ğŸ“¸ Ejecutar capturas MANUALES
      env:
        MAX_WORKERS: ${{ github.event.inputs.max_workers || '1' }}
      run: |
        echo "ğŸ§ª EJECUTANDO PRUEBA MANUAL"
        echo "================================"
        echo "âš™ï¸ Workers simultÃ¡neos: $MAX_WORKERS"
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ¯ Modo: SOLO PRUEBA (no automÃ¡tico)"
        echo ""
        
        python3 scripts/capture.py --max-workers $MAX_WORKERS
        
    - name: ğŸ“Š Generar reportes de prueba
      if: always()
      run: |
        echo "ğŸ“‹ Generando reportes de prueba..."
        
        # NO actualizar README en modo prueba
        echo "â„¹ï¸ Saltando actualizaciÃ³n de README (modo prueba)"
        
        # Mostrar resumen en logs
        if [ -f "capturas/latest/report.json" ]; then
          echo ""
          echo "ğŸ“Š RESUMEN DE PRUEBA:"
          echo "====================="
          python3 -c "
import json
try:
    with open('capturas/latest/report.json', 'r') as f:
        data = json.load(f)
    stats = data.get('estadisticas', {})
    print(f'âœ… Exitosas: {stats.get("exitosas", 0)}')
    print(f'âŒ Fallidas: {stats.get("fallidas", 0)}')
    print(f'â±ï¸ Tiempo total: {stats.get("tiempo_total_segundos", 0):.1f}s')
    print(f'ğŸ’¾ TamaÃ±o total: {stats.get("tamaÃ±o_total_mb", 0):.1f} MB')
except Exception as e:
    print(f'Error leyendo reporte: {e}')
"
        fi
        
    - name: ğŸ“¦ Crear archivo comprimido de prueba
      if: success()
      run: |
        echo "ğŸ“¦ Creando archivo de prueba..."
        
        if [ -d "capturas" ]; then
          fecha=$(date +%Y-%m-%d-%H%M)
          zip_name="PRUEBA-capturas-$fecha"
          
          cd capturas
          zip -r "../$zip_name.zip" . -i "*.html" "*.json" "*.md"
          cd ..
          
          echo "âœ… Archivo de prueba creado: $zip_name.zip"
          
          if [ -f "$zip_name.zip" ]; then
            size_mb=$(du -m "$zip_name.zip" | cut -f1)
            echo "ğŸ“¦ TamaÃ±o del ZIP de prueba: ${size_mb}MB"
          fi
        fi
        
    - name: ğŸ“¤ Subir capturas de prueba
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: PRUEBA-capturas-${{ github.run_number }}
        path: |
          PRUEBA-*.zip
          capturas/latest/
        retention-days: 7
        compression-level: 0
        
    - name: âœ… Resumen de prueba
      if: always()
      run: |
        echo ""
        echo "ğŸ§ª ========================================"
        echo "    PRUEBA MANUAL COMPLETADA"
        echo "========================================"
        echo ""
        echo "ğŸ“… Fecha: $(date)"
        echo "ğŸ¯ Modo: SOLO PRUEBA MANUAL"
        echo "ğŸ”¢ EjecuciÃ³n: #${{ github.run_number }}"
        echo ""
        echo "ğŸ“Š Para ver resultados:"
        echo "   â€¢ Descarga 'PRUEBA-capturas-XXX' en Artifacts"
        echo "   â€¢ Revisa las capturas en el ZIP"
        echo ""
        echo "ğŸš€ Si funciona bien:"
        echo "   â€¢ Puedes habilitar la automatizaciÃ³n semanal"
        echo "   â€¢ O seguir ejecutando manualmente cuando necesites"
        echo ""
